---
import type { ZodDate } from 'astro:schema';
import { videos } from '../data/videos.js';

function timeAgo(dateString: string | number | Date | ZodDate | undefined) {
  const now = new Date();
  let date: Date;

  if (!dateString) {
    return 'Fecha desconocida';
  } else if (dateString instanceof Date) {
    date = dateString;
  } else if (typeof dateString === 'object' && 'toDate' in dateString && typeof dateString.toDate === 'function') {
    date = dateString.toDate();
  } else if (typeof dateString === 'string' || typeof dateString === 'number') {
    date = new Date(dateString);
  } else {
    return 'Fecha desconocida';
  }

  const diffMs = now.getTime() - date.getTime();
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
  const diffMonths = Math.floor(diffDays / 30);
  const diffYears = Math.floor(diffDays / 365);

  if (diffYears > 0) return `hace ${diffYears} año${diffYears > 1 ? 's' : ''} `;
  if (diffMonths > 0) return `hace ${diffMonths} mes${diffMonths > 1 ? 'es' : ''} `;
  if (diffDays > 0) return `hace ${diffDays} día${diffDays > 1 ? 's' : ''} `;
  return 'Hoy';
}

const sortedVideos = [...videos].sort((a, b) => {
  const dateA = a.date ? new Date(a.date).getTime() : 0;
  const dateB = b.date ? new Date(b.date).getTime() : 0;
  return dateB - dateA;
});
---

<div class="container-fluid my-5 d-flex justify-content-center">
    <div class="row g-4" style="width: 70vw; max-width: 1920px;">
        {sortedVideos.map(video => (
            <div class="col-12 col-md-6 col-xl-4 d-flex flex-column align-items-center">
                <div class="video-frame-wrapper">
                    <iframe 
                        src={video.url}
                        title={video.titulo}
                        allowfullscreen
                        loading="lazy"
                        style="width:100%; height:100%; border:0;"
                    ></iframe>
                </div>
                <p class="text-white mt-2 w-100 text-center">
                    {video.titulo}
                    <span class="text-secondary ms-2" style="font-size:0.95em;">
                        • {timeAgo(video.date)}
                    </span>
                </p>
            </div>
        ))}
    </div>
</div>

<style>

.video-frame-wrapper {
  width: 100%;
  aspect-ratio: 16 / 9;
  border-radius: 1.5rem;
  overflow: hidden;
  background: #000;
  max-width: 1920px;
  margin: 0 auto;
}
@media (max-width: 767px) {
  .video-frame-wrapper {
    border-radius: 0;
  }
}
</style>